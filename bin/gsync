#!/usr/bin/env bash
set -e

echo "=== gsync: Syncing with remote ==="

# Fetch and prune stale remote-tracking branches
git fetch --prune

# Auto-detect default branch from remote
default_branch=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
current_branch=$(git branch --show-current)

if [[ "$current_branch" == "$default_branch" ]]; then
  git pull origin "$default_branch"
else
  echo "On branch '$current_branch', fetched '$default_branch' from origin"
fi

# Find local branches with no matching remote branch
remote_branches=$(git branch -r | grep -v HEAD | sed 's|^[^/]*/||' | sort -u)
mapfile -t local_branches < <(git branch --format '%(refname:short)')
stale_branches=()

for branch in "${local_branches[@]}"; do
  # Skip protected branches (default branch already detected above)
  if [[ "$branch" == "$default_branch" ]]; then
    continue
  fi

  # Check if remote branch exists
  if ! echo "$remote_branches" | grep -qx "$branch"; then
    stale_branches+=("$branch")
  fi
done

if [[ ${#stale_branches[@]} -gt 0 ]]; then
  echo ""
  echo "Local branches with no matching remote:"

  for branch in "${stale_branches[@]}"; do
    if [[ "$branch" == "$current_branch" ]]; then
      echo "  ⚠ $branch (skipped - currently checked out)"
      continue
    fi

    # Check for commits not merged into default branch
    unmerged_count=$(git log "$default_branch..$branch" --oneline 2>/dev/null | wc -l | tr -d ' ')

    if [[ "$unmerged_count" -gt 0 ]]; then
      echo "  ⚠ $branch has $unmerged_count commit(s) not in $default_branch"
      read -p "    Delete anyway? [y/N] " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        git branch -D "$branch"
        echo "    ✓ Force deleted"
      else
        echo "    ⏭ Skipped"
      fi
    elif git branch -d "$branch" 2>/dev/null; then
      echo "  ✓ $branch (deleted - fully merged)"
    else
      echo "  ✗ $branch cannot be safely deleted (not fully merged)"
      read -p "    Force delete? [y/N] " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        git branch -D "$branch"
        echo "    ✓ Force deleted"
      else
        echo "    ⏭ Skipped"
      fi
    fi
  done
else
  echo "No stale local branches to clean up"
fi

# Auto-detect pnpm project and run install/build/test (if scripts exist)
if [[ -f "package.json" ]] && [[ -f "pnpm-lock.yaml" ]]; then
  echo ""
  echo "Detected pnpm project, running install..."
  pnpm i
  pnpm run --if-present build
  pnpm run --if-present test
fi

echo ""
echo "=== gsync complete ==="
